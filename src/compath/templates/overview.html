{% extends "base.html" %}

{% import "bootstrap/wtf.html" as wtf %}
{% import "bootstrap/fixes.html" as fixes %}
{% import "bootstrap/utils.html" as util %}

{% block title %}ComPath Overview{% endblock %}


{% block styles %}
    {{ super() }}

    <style>
        /* VennDiagram CSS */

        svg path {
            stroke: white;
            stroke-width: 2px;
        }

        #coverage-venn-diagram svg text {
            fill: white;
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 14px !important;
        }

        .venntooltip {
            position: absolute;
            text-align: center;
            width: 128px;
            height: 25px;
            background: #333;
            color: #ddd;
            padding: 2px;
            border: 0px;
            border-radius: 8px;
            opacity: 0;
        }

        /* Histogram CSS */

        .bar rect {
            fill: steelblue;
        }

        .bar text {
            fill: #fff;
            font: 10px sans-serif;
        }

        .bar:hover {
            fill: brown;
        }

        .toolTip {
            position: absolute;
            display: none;
            min-width: 80px;
            height: auto;
            background: none repeat scroll 0 0 #ffffff;
            border: 1px solid #6F257F;
            padding: 14px;
            text-align: center;
        }
    </style>

{% endblock %}

{% block scripts %}
    {{ super() }}
    {% include "dependencies/common.html" %}

    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script type="text/javascript"
            src="https://benfred.github.io/venn.js/venn.js"></script>
    <script>

        // Venn Diagram Script

        var data = {{ managers_overlap|safe }};

        var coverageVenn = d3.select("#coverage-venn-diagram");

        coverageVenn.attr("align", "center"); // Align center the diagram

        var ignorome = venn.VennDiagram(); // Plot the Venn Diagram
        coverageVenn.datum(data).call(ignorome); // Stick data

        // add a tooltip
        var tooltip = d3.select("body").append("div")
            .attr("class", "venntooltip");

        // add listeners to all the groups to display tooltip on mouseover
        coverageVenn.selectAll("g")
            .on("mouseover", function (d, i) {
                // sort all the areas relative to the current item
                venn.sortAreas(coverageVenn, d);

                // Display a tooltip with the current size
                tooltip.transition().duration(400).style("opacity", .9);
                tooltip.text(d.size + " genes");

                // highlight the current path
                var selection = d3.select(this).transition("tooltip").duration(400);
                selection.select("path")
                    .style("stroke-width", 3)
                    .style("fill-opacity", d.sets.length == 1 ? .4 : .1)
                    .style("stroke-opacity", 1);
            })

            .on("mousemove", function () {
                tooltip.style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
            })

            .on("mouseout", function (d, i) {
                tooltip.transition().duration(400).style("opacity", 0);
                var selection = d3.select(this).transition("tooltip").duration(400);
                selection.select("path")
                    .style("stroke-width", 0)
                    .style("fill-opacity", d.sets.length == 1 ? .25 : .0)
                    .style("stroke-opacity", 0);
            });

    </script>

    <script>
        {% for resource, distribution in distributions.items() %}

            var distribution = {{ distribution|safe }};

            /* Plot Histogram */

            var histogramData = [];
            $.each(distribution, function (key, value) {
                histogramData.push(value)
            });

            var formatCount = d3.format(",.0f");

            var svg = d3.select("#{{ resource|safe }}" + "-svg"),
                margin = {
                    top: 10,
                    right: 30,
                    bottom: 30,
                    left: 30
                },
                width = +svg.attr("width") - margin.left - margin.right,
                height = +svg.attr("height") - margin.top - margin.bottom,
                g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var tooltip = d3.select("body").append("div").attr("class", "toolTip");

            var x = d3.scaleLinear()
                .domain(d3.extent(histogramData))
                .rangeRound([0, width]);

            var histogram = d3.histogram()
                .domain(x.domain())
                .thresholds(x.ticks(60));

            var bins = histogram(histogramData);

            var y = d3.scaleLinear()
                .domain([0, d3.max(bins, function (d) {
                    return d.length;
                })])
                .range([height, 0]);

            var bar = g.selectAll(".bar")
                .data(bins)
                .enter().append("g")
                .attr("class", "bar")
                .attr("transform", function (d) {
                    return "translate(" + x(d.x0) + "," + y(d.length) + ")";
                })
                .on("mousemove", function (d) {
                    tooltip
                        .style("left", d3.event.pageX - 50 + "px")
                        .style("top", d3.event.pageY - 70 + "px")
                        .style("display", "inline-block")
                        .html((d.length) + "<br>" + "Pathways");
                })
                .on("mouseout", function (d) {
                    tooltip.style("display", "none");
                });

            bar.append("rect")
                .attr("x", 1)
                .attr("width", x(bins[0].x1) - x(bins[0].x0) - 1)
                .attr("height", function (d) {
                    return height - y(d.length);
                });

            bar.append("text")
                .attr("dy", ".75em")
                .attr("y", 6)
                .attr("x", (x(bins[0].x1) - x(bins[0].x0)) / 2)
                .attr("text-anchor", "middle")
                .text(function (d) {
                    return formatCount(d.length);
                });

            g.append("g")
                .attr("class", "axis axis--x")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x));

        {% endfor %}


    </script>
{% endblock %}

{% block content %}
    <div class="container">
        {{ util.flashed_messages(dismissible=True, container=False) }}

        <div class="panel panel-default">
            <div class="panel-heading">ComPath Overview</div>
            <div class="panel-body">
                <p>Summary of the pathway databases loaded in ComPath and their content</p>

                <table class="table table-striped table-hover">
                    <thead>
                    <tr>
                        <th class="first-row">Resource</th>
                        <th class="first-row">Number of Pathways</th>
                        <th class="first-row">Number of Genes</th>
                    </tr>
                    </thead>
                    <tbody>

                    {% for resource, (number_of_pathways, number_of_genes) in resource_overview.items() %}
                        <tr>
                            <td> {{ resource|upper }}</td>
                            <td>{{ number_of_pathways }}</td>
                            <td>{{ number_of_genes }}</td>
                        </tr>
                    {% endfor %}

                    </tbody>

                </table>
            </div>
        </div>

        <div class="panel panel-default">
            <div class="panel-heading">Pathway Knowledge Coverage and Ignorome</div>
            <div class="panel-body">
                <p>This Venn diagram shows the genetic coverage over all HGNC symbols known for all databases.</p>
                <div id="coverage-venn-diagram">
                </div>
            </div>
        </div>


        <div class="panel panel-default">
            <div class="panel-heading">Pathway Size Distribution</div>
            <div class="panel-body">
                <p>
                    Analyze the distribution of the pathways for each individual database. In other words, what are the
                    biggest and smalles pathways. This analysis might help you to interpret the results of enrichment
                    analyses as well as analyze the boundaries of databases. Click in the pathway database buttons to go
                    to their dedicated pages.
                </p>
                <p>
                    {% for resource in managers %}
                        {% if resource not in BLACK_LIST %}
                            <a href="{{ url_for('analysis.pathway_distribution', resource=resource) }}"
                               class="btn btn-primary">
                                {{ resource|upper }}
                            </a>
                        {% endif %}
                    {% endfor %}
                </p>

                {% for resource in managers %}
                    {% if resource not in BLACK_LIST %}

                        <svg id="{{ resource }}-svg" width="300" height="300"></svg>

                    {% endif %}
                {% endfor %}


            </div>
        </div>

        <div class="panel panel-default">
            <div class="panel-heading">Gene Promiscuity</div>
            <div class="panel-body">
                <p>
                    Analyze the gene promiscuity for each pathway database. In other words, which genes act and belong
                    to more or less pathways in each database. Click in the pathway database buttons to go to their
                    dedicated pages.
                </p>
                <p>
                    {% for resource in managers %}
                        {% if resource not in BLACK_LIST %}

                            <a href="{{ url_for('analysis.gene_distribution', resource=resource) }}"
                               class="btn btn-primary">
                                {{ resource|upper }}
                            </a>
                        {% endif %}

                    {% endfor %}
                </p>

            </div>
        </div>

    </div>
    {% include "footer.html" %}
{% endblock %}
