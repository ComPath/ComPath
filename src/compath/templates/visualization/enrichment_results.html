{% extends "base.html" %}

{% import "bootstrap/wtf.html" as wtf %}
{% import "bootstrap/fixes.html" as fixes %}
{% import "bootstrap/utils.html" as util %}

{% block title %}Enriched Pathways{% endblock %}xz


{% block styles %}
    {{ super() }}
    <style>
        td {
            overflow: hidden;
            max-width: 200px;
            word-wrap: break-word;
        }
    </style>
{% endblock %}

{% block scripts %}
    {{ super() }}
    {% include "dependencies/datatables.html" %}


    <script>

        $(document).ready(function () {

            var tables = [];

            {% for resource_name in query_results.keys() %}

                var table = $("#{{ resource_name }}" + "-table").DataTable(
                    {
                        dom: "<'row'<'col-sm-2'l><'col-sm-3'f><'col-sm-5'B>>" +
                        "<'row'<'col-sm-12'tr>>" +
                        "<'row'<'col-sm-5'i><'col-sm-7'p>>",
                        buttons: [
                            'copy', 'csv', 'excel', 'pdf', 'print'
                        ]
                    }
                );

                tables.push(table);

            {% endfor %}

            var form = $('#compare-pathways-form');

            // Controls that at least two pathways have been selected
            $('button[type="submit"]').on('click', function (e) {
                e.preventDefault(); // Prevent the default submission

                // In case the user comes back from the analysis page, make sure the added inputs are deleted so there are no duplicates
                form.empty();

                // Add the analysis info from the clicked button
                $(form).append(
                    $('<input>')
                        .attr('type', 'hidden')
                        .attr('name', $(this).attr("name"))
                        .val($(this).val())
                );

                // For each table add a hidden input to the form with the checked boxes
                $.each(tables, function (index, table) {

                    $.each(table.$('input'), function (index, input) {

                        if (input.checked) {
                            $(form).append(
                                $('<input>')
                                    .attr('type', 'hidden')
                                    .attr('name', input.name)
                                    .val(input.value)
                            );
                        }
                    });
                });

                // Check there are at least 2 pathways selected (so the analysis input plus two more (3))
                if (form.children().length <= 2) {
                    alert('Please select at least two pathways for comparison.');
                    return false;
                }

                // Submit form
                form.submit();

            });

            // Clicks all buttons in all tables
            $('#selectAll').click(function (e) {

                var boolean = $(this).prop('checked');

                // For each table add a hidden input to the form with the checked boxes
                $.each(tables, function (index, table) {
                    $.each(table.$('input'), function (index, input) {
                        input.checked = boolean;
                    });
                });
            });


        });
    </script>
{% endblock %}

{% block content %}
    <div class="container">
        <div class="page-header">
            <h1>Query Results</h1>
            <hr>
            {{ util.flashed_messages(dismissible=True, container=False) }}

            <p>The enriched pathways are presented in different tables for each resource loaded into ComPath.
                The pathway enrichment is presented in the third column (adjusted <i>p</i>-values) by performing a
                Fisher's Exact Test for each mapped pathway in all resources and adjusting the values using Benjamini &
                Hochberg correction. The purpose of the adjusted <i>p</i>-values (rounded to 4 decimal places) is to
                guide the user on what pathway selection should use for further analysis.
            </p>

            <table class="table table-bordered table-striped table-hover">
                <tbody>
                <tr>
                    <td>Gene Symbols Submitted</td>
                    <td>
                        {% for hgnc_symbol in submitted_gene_set %}
                            <a href="https://www.ncbi.nlm.nih.gov/gene/?term={{ hgnc_symbol }}">{{ hgnc_symbol }}</a>
                            {{ "," if not loop.last }}
                        {% endfor %}
                    </td>
                </tr>
                <tr>
                    <td>Number of Pathways Mapped</td>
                    <td>{{ number_of_pathways }}</td>
                </tr>
                <tr>
                    <td>Select All Pathways</td>
                    <td>
                        <input type="checkbox" id="selectAll"/>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <form id="compare-pathways-form" method="get" action="{{ url_for('analysis.compare_pathways') }}">
        </form>

        <p>First, select your pathways of interest and click in the type of analysis to perform. The "Venn Diagram"
            button displays the overlap between the selected pathways represented as Venn Diagrams, "Dendrogram"
            clusters the pathways and present a dendrogram where users can further investigate the pathway groups,
            and finally, the "Network" button renders the similarity between the selection of pathways as well as the
            neighborhood of curated mappings linked with the selection.
        </p>
        <div class="text-center">
            <button class="btn btn-primary" name="analysis" value="venn" type="submit">Venn Diagram</button>
            <button class="btn btn-primary" name="analysis" value="dendrogram" type="submit">Dendrogram</button>
            <button class="btn btn-primary" name="analysis" value="network" type="submit">Network</button>
        </div>

        <hr>
        {% for resource_name, pathway_dict in query_results.items() %}

            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">{{ resource_name|upper }}</h3>
                </div>
                <div class="panel-body">

                    <table class="table table-hover table-responsive table-striped" id="{{ resource_name }}-table">
                        <thead>
                        <tr>
                            <th></th>
                            <th>Pathway Name</th>
                            <th>Resource Identifier</th>
                            <th>Adjusted <i>p</i>-value</th>
                            <th>Genes Mapped</th>
                            <th>Pathway Size</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for pathway_id, enriched_pathway in pathway_dict.items() %}
                            <tr>
                                <td>
                                    <label>
                                        <input type="checkbox" name="pathways[]"
                                               value="{{ resource_name }}|{{ enriched_pathway["pathway_name"] }}"/>
                                    </label>
                                </td>
                                <td>
                                    <a href="{{ url_for("model.pathway_view",resource=resource_name, identifier=enriched_pathway["pathway_id"] ) }}">
                                        {{ enriched_pathway["pathway_name"] }}
                                    </a>
                                </td>
                                <td>
                                    {% if resource_name == "reactome" %}
                                        <a href="https://reactome.org/PathwayBrowser/#/{{ enriched_pathway["pathway_id"] }}">
                                            {{ enriched_pathway["pathway_id"] }}
                                        </a>
                                    {% elif resource_name == "kegg" %}
                                        <a href="http://www.kegg.jp/kegg-bin/show_pathway?map=map{{ enriched_pathway["pathway_id"]|remove_prefix('path:hsa') }}&show_description=show">
                                            {{ enriched_pathway["pathway_id"] }}
                                        </a>
                                    {% elif resource_name == "wikipathways" %}
                                        <a href="https://www.wikipathways.org/index.php/Pathway:{{ enriched_pathway["pathway_id"] }}">
                                            {{ enriched_pathway["pathway_id"] }}
                                        </a>
                                    {% elif resource_name == "msig" %}
                                        <a href="http://www.broadinstitute.org/gsea/msigdb/cards/{{ enriched_pathway["pathway_id"] }}">
                                            {{ enriched_pathway["pathway_id"] }}
                                        </a>
                                    {% else %}
                                        {{ enriched_pathway["pathway_id"] }}
                                    {% endif %}
                                </td>
                                <td>
                                    {{ enriched_pathway["q_value"] }}
                                </td>
                                <td>
                                    {{ enriched_pathway["mapped_proteins"] }}
                                </td>
                                <td>
                                    {{ enriched_pathway["pathway_size"] }}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% endfor %}
    </div>

    {% include "footer.html" %}
{% endblock %}
