{% extends "base.html" %}

{% import "bootstrap/wtf.html" as wtf %}
{% import "bootstrap/fixes.html" as fixes %}
{% import "bootstrap/utils.html" as util %}

{% block title %}ComPath{% endblock %}


{% block styles %}
    {{ super() }}
    <link rel="stylesheet" type="text/css" href='https://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css'/>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs/dt-1.10.16/datatables.min.css"/>

    <style>

        /* Fuse dynamic field buttons */

        [data-role="dynamic-fields"] > .form-inline + .form-inline {
            margin-top: 0.5em;
        }

        [data-role="dynamic-fields"] > .form-inline [data-role="add"] {
            display: none;
        }

        [data-role="dynamic-fields"] > .form-inline:last-child [data-role="add"] {
            display: inline-block;
        }

        [data-role="dynamic-fields"] > .form-inline:last-child [data-role="remove"] {
            display: none;
        }

        /* Gene Sets in table info */

        td {
            overflow: scroll;
        }

        /* VennDiagram CSS */

        svg path {
            stroke: white;
            stroke-width: 2px;
        }

        .venntooltip {
            position: absolute;
            text-align: center;
            width: 128px;
            height: 25px;
            background: #333;
            color: #ddd;
            padding: 2px;
            border: 0px;
            border-radius: 8px;
            opacity: 0;
        }

        #overlap-venn-diagram svg text {
            fill: white;
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 14px !important;
        }

        /* Histogram CSS */

        .bar rect {
            fill: steelblue;
        }

        .bar text {
            fill: #fff;
            font: 10px sans-serif;
        }

        .bar:hover {
            fill: brown;
        }

        .toolTip {
            position: absolute;
            display: none;
            min-width: 80px;
            height: auto;
            background: none repeat scroll 0 0 #ffffff;
            border: 1px solid #6F257F;
            padding: 14px;
            text-align: center;
        }
    </style>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js"></script>
    <script type="text/javascript"
            src="https://npmcdn.com/tether@1.2.4/dist/js/tether.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script type="text/javascript"
            src="https://benfred.github.io/venn.js/venn.js"></script>
    <script type="text/javascript"
            src="{{ url_for('static', filename='js/overview_controller.js', version='20180501') }}"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs/dt-1.10.16/datatables.min.js"></script>

    <script>

        $(document).ready(function () {

            {% for manager, distribution_data in manager_distribution_dict.items() %}

                $("#{{ manager|safe }}" + "-table").DataTable();

                var data = {{ distribution_data|safe }};

                /* Plot Histogram */

                var histogramData = [];
                $.each(data, function (key, value) {
                    histogramData.push(value)
                });

                var formatCount = d3.format(",.0f");

                var svg = d3.select("#{{ manager|safe }}" + "-histogram"),
                    margin = {
                        top: 10,
                        right: 30,
                        bottom: 30,
                        left: 30
                    },
                    width = +svg.attr("width") - margin.left - margin.right,
                    height = +svg.attr("height") - margin.top - margin.bottom,
                    g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                var tooltip = d3.select("body").append("div").attr("class", "toolTip");

                var x = d3.scaleLinear()
                    .domain(d3.extent(histogramData))
                    .rangeRound([0, width]);

                var histogram = d3.histogram()
                    .domain(x.domain())
                    .thresholds(x.ticks(40));

                var bins = histogram(histogramData);

                var y = d3.scaleLinear()
                    .domain([0, d3.max(bins, function (d) {
                        return d.length;
                    })])
                    .range([height, 0]);

                var bar = g.selectAll(".bar")
                    .data(bins)
                    .enter().append("g")
                    .attr("class", "bar")
                    .attr("transform", function (d) {
                        return "translate(" + x(d.x0) + "," + y(d.length) + ")";
                    })
                    .on("mousemove", function (d) {
                        tooltip
                            .style("left", d3.event.pageX - 50 + "px")
                            .style("top", d3.event.pageY - 70 + "px")
                            .style("display", "inline-block")
                            .html((d.length) + "<br>" + "Pathways");
                    })
                    .on("mouseout", function (d) {
                        tooltip.style("display", "none");
                    });

                bar.append("rect")
                    .attr("x", 1)
                    .attr("width", x(bins[0].x1) - x(bins[0].x0) - 1)
                    .attr("height", function (d) {
                        return height - y(d.length);
                    });

                bar.append("text")
                    .attr("dy", ".75em")
                    .attr("y", 6)
                    .attr("x", (x(bins[0].x1) - x(bins[0].x0)) / 2)
                    .attr("text-anchor", "middle")
                    .text(function (d) {
                        return formatCount(d.length);
                    });

                g.append("g")
                    .attr("class", "axis axis--x")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x));




            {% endfor %}
        });
    </script>


{% endblock %}

{% block content %}
    <div class="container" style="margin-top: 50px">
        {{ util.flashed_messages(dismissible=True, container=False) }}

        <div class="panel panel-default">
            <div class="panel-heading">Visualize Gene Set Overlap across Pathways</div>
            <div class="panel-body">
                <form id="venn-diagram-form">
                    <p>Select the pathway of interest to plot a Venn diagram to visualize their gene set overlap. Double
                        click in the circles to see information about the pathways and their overlap.</p>
                    <div data-role="dynamic-fields">
                        <div class="form-inline">
                            <div class="form-group">
                                <label class="sr-only" for="pathway">Pathways</label>
                                <input type="text" class="form-control" name="pathways[]" id="pathway-name-1"
                                       placeholder="Select the Pathway to compare"
                                       style=" min-width: 500px;">
                                <select type="text" class="form-control" name="resources[]" id="select-1">
                                    {% for manager in manager_distribution_dict.keys() %}
                                        <option value="{{ manager }}">{{ manager|upper }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button class="btn btn-danger" data-role="remove">
                                <span class="glyphicon glyphicon-remove"></span>
                            </button>
                            <button class="btn btn-primary" data-role="add">
                                <span class="glyphicon glyphicon-plus"></span>
                            </button>
                        </div>  <!-- /div.form-inline -->
                    </div> <!-- /div[data-role="dynamic-fields"] -->
                    <div class="text-center" style="margin-top: 20px; margin-bottom: 20px">
                        <input class="btn btn-primary btn-lg" value="Render Plot" type="submit">
                    </div>
                    <div id="overlap-venn-diagram"></div>
                    <div class="panel panel-default" id="info-table-container">
                        <table id="info-table" class="table table-bordered table-hover table-responsive"></table>
                    </div>
                </form>
            </div>
        </div>

        <div class="panel panel-default">
            <div class="panel-heading">Pathway Size Distribution</div>
            <div class="panel-body">
                <p>Explore the distribution of the pathway sizes across different resources. Each histogram contains 40
                    bins each one in the 50 unit range (from 0 to 50, 50 to 100...). The aim of this plot is just to
                    show the distribution and the outliers, in order to inspect and find the name of the outliers,
                    please use the table in the section below. </p>

                {% for manager in manager_distribution_dict.keys() %}

                    <h3 class="text-center">{{ manager|upper }}</h3>
                    <svg id="{{ manager }}-histogram" width="960" height="500"></svg>

                    {% if not loop.last %}
                        <hr>
                    {% endif %}
                {% endfor %}

            </div>
        </div>

        <div class="panel panel-default">
            <div class="panel-heading">Pathway Overview</div>
            <div class="panel-body">
                <p>Explore the size in detail using DataTable.</p>

                {% for manager, distribution_data in manager_distribution_dict.items() %}

                    <h3 class="text-center">{{ manager|upper }}</h3>

                    <table id="{{ manager }}-table" class="table table-striped table-hover">
                        <thead>
                        <tr>
                            <th class="first-row">Pathway Name</th>
                            <th class="first-row">Gene Set Size</th>
                        </tr>
                        </thead>
                        <tbody>

                        {% for pathway, size in distribution_data.items() %}

                            <tr>
                                <td> {{ pathway }}</td>
                                <td>{{ size }}</td>
                            </tr>

                        {% endfor %}

                        </tbody>

                    </table>
                    {% if not loop.last %}
                        <hr>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
    {% include "footer.html" %}
{% endblock %}
